<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width">
		<title>Thoughts on Consumer Group of Apache Kafka</title>
		<link href="/css/main.css" type="text/css" rel="stylesheet">
		<link href="/css/syntax.css" type="text/css" rel="stylesheet">
		<link href="/css/materialize.min.css" type="text/css" rel="stylesheet">
		<link href="/img/favicon.ico" rel="icon">
        <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
	</head>
	<body>		
		<nav class="teal lighten-2">
			<div class="nav-wrapper">
				<div class="container">
                    <a href="/" class="brand-logo hide-on-med-and-down">Salmon Blog</a>
					<ul id="nav" class="right">
						<li><a href="/">Home</a></li>
						<li><a href="http://apps.wanwenli.com">Salmon Apps</a></li>
						<li><a href="/categories.html">Categories</a></li>
					</ul>
				</div>
			</div>
		</nav>
		<div class="container">
            <div class="section">
                <div class="row">
                    <div class="col l9 s12">
                        <div class="content"><h3>Thoughts on Consumer Group of Apache Kafka</h3>
<b>25 Oct 2016</b>
<div id="article">
<h4 id="introduction">Introduction</h4>

<p>The concept of consumer group is intriguring.
According to the
<a href="http://kafka.apache.org/documentation.html#introduction">official documentation of Kafka</a>,
one of its main objectives is to achieve message multicast and broadcast.
Often it is not an easy concept to understand for newbies.
This article will share a few issues and discoveries about consumer group.</p>

<p>A good way to start understanding consumer group is
looking at its data structure within ZooKeeper,
which is illustrated below.</p>

<p><img src="/img/consumer-group-zk.png" alt="Your browser does not support img" /></p>

<p>You may see each consumer group as a separated world in terms of message consumption.
Each consuemr group maintains its own consumer IDâ€™s,
partition owners and offsets.</p>

<h4 id="rebalance">Rebalance</h4>

<p>Consumer rebalance happens when consumers join or leave a consumer group or
when the topics within a consumer group have new partitions.</p>

<p>Consumer ID uniquely identitfies a consumer.
It is generated automatically when a consumer is launched.
The source code of its generation is defined in <a href="https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/consumer/ZookeeperConsumerConnector.scala">ZookeeperConsumerConnector.scala</a>
and shown below.</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">var</span> <span class="n">consumerUuid</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="kc">null</span>
<span class="n">config</span><span class="o">.</span><span class="n">consumerId</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">consumerId</span><span class="o">)</span> <span class="c1">// for testing only
</span>  <span class="k">=&gt;</span> <span class="n">consumerUuid</span> <span class="k">=</span> <span class="n">consumerId</span>
  <span class="k">case</span> <span class="nc">None</span> <span class="c1">// generate unique consumerId automatically
</span>  <span class="k">=&gt;</span> <span class="k">val</span> <span class="n">uuid</span> <span class="k">=</span> <span class="nc">UUID</span><span class="o">.</span><span class="n">randomUUID</span><span class="o">()</span>
  <span class="n">consumerUuid</span> <span class="k">=</span> <span class="s">"%s-%d-%s"</span><span class="o">.</span><span class="n">format</span><span class="o">(</span>
    <span class="nc">InetAddress</span><span class="o">.</span><span class="n">getLocalHost</span><span class="o">.</span><span class="n">getHostName</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">,</span>
    <span class="n">uuid</span><span class="o">.</span><span class="n">getMostSignificantBits</span><span class="o">().</span><span class="n">toHexString</span><span class="o">.</span><span class="n">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">8</span><span class="o">))</span>
<span class="o">}</span>
<span class="n">config</span><span class="o">.</span><span class="n">groupId</span> <span class="o">+</span> <span class="s">"_"</span> <span class="o">+</span> <span class="n">consumerUuid</span></code></pre></figure>

<p>If you go into <code class="highlighter-rouge">/owners</code> directory and check the owner of a partition,
you should find a very similar value to consumer ID.
The owner of a topic-partition is defined in the form of <code class="highlighter-rouge">[consumerId]-[threadId]</code> in which <code class="highlighter-rouge">threadId</code> is used
because one partition is meant to be consumed by at most one thread.
In many cases, the <code class="highlighter-rouge">threadId</code> is equal to the partition number which
the consumer thread owns.</p>

<p>A consumer group is <em>well balanced</em>
if each partition inside it is owned by exactly one consumer thread.
You may use the instructions from <a href="https://cwiki.apache.org/confluence/display/KAFKA/System+Tools#SystemTools-VerifyConsumerRebalance">this link</a>
to verify the result of consumer rebalance.
This tool should work well because I have fixed a bug in <code class="highlighter-rouge">VerifyConsumerRebalance.scala</code> in a <a href="https://github.com/apache/kafka/pull/1612">pull request</a>.</p>

<h4 id="broadcast">Broadcast</h4>

<p>Broadcast by Kafka is relatively cheap:
you just need to put each consumer in different consumer groups,
such that the offset of each consumer is different.</p>

<p>Once I read some articles online which suggest use <code class="highlighter-rouge">UUID</code> within
a consumer group, for example <a href="http://stackoverflow.com/questions/30647544/kafka-multiple-consumers-for-a-partition">this question</a> from stackoverflow and
it has received more than 5 upvotes.
Unfortunately I <strong>strongly discourage</strong> such usage.</p>

<p>Firstly and most importantly, consumer groups are stored as persistent nodes in ZooKeeper.
Often consumers need to be shutdown and started,
which may not be frequent in commercial environments
but is expected to be quite frequent in develop, test and staging phases.
As time goes by a huge number of consumer groups nodes
shall be accumulated in <code class="highlighter-rouge">/consumers</code> node and
most of them are not in use.
A direct result is
it is almost impossible to list out all the consumer groups.
ZooKeeper client throws runtime exception due to buffer overflow due to
the overwhelming amount of child nodes.
The error message is something like:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>IOException Packet &lt;len12343123123&gt; is out of range
</code></pre>
</div>

<p>Even you configure the <code class="highlighter-rouge">jute.maxbuffer</code> parameter as some blogs suggest,
the chance of receiving a response
before your patience runs out is extremely low.
I have encountered a situation where <code class="highlighter-rouge">/consumers</code> has more than 90,000
child nodes and was unable to list up consumer groups ever since.
Another direct result is that some features of <a href="https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/admin/ConsumerGroupCommand.scala">ConsumerGroupCommand</a>
(used in kafka-consumer-groups.sh)
will fail because internally it lists out all consumer groups.</p>

<p>However, the huge number of consumer groups should <em>not</em> be a problem
for the normal operation of Kafka,
because the brokers do not need to know all the groups.
Even though from version 0.9 onward,
consumer rebalance is coordinated by brokers,
brokers do not scan groups when deciding which broker coordinates
which subset of them.
They only manage those consumer which join or leave them.
As far as what I have read from <a href="https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/GroupCoordinator.scala">GroupCoordinator.scala</a>,
brokers do not scan all consumer groups.</p>

<p>Next, <code class="highlighter-rouge">UUID</code> is hardly queryable.
Its value is generated at runtime and unpredictable.
If you wish to describe a consumer group or check its offsets,
you will face problems on finding the exact value of it.
A workaround is to <em>log</em> its value somewhere.</p>

<p>Last but not the least,
group names with <code class="highlighter-rouge">UUID</code> in them is brand new every time.
Upon the creation of a new consumer group,
the value of offsets is determined by offset reset,
in other words the setting of <code class="highlighter-rouge">auto.offset.reset</code>.
No matter the value is <code class="highlighter-rouge">smallest</code> or <code class="highlighter-rouge">largest</code>,
the consumer either consumes many messages repeatedly or
skip some messages.</p>

<h4 id="delete-a-group">Delete a group</h4>

<p>Deleting a consumer group from ZooKeeper is
as easy as one single instruction.
However, it implies that the offset information
will be permantly deleted from ZooKeeper.
Do it only when you are 100% sure that
the target group will never be reused.</p>

</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'wanwenli'; // required: replace example with your forum shortname

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                    </div>
                    <div class="col l3 s12">
                        <h4 class="grey-text text-darken-4">Links</h4>
                        <ul>
                            <li><a href="http://chenyuio.com">Chen Yu I/O</a></li>
                            <li><a href="http://www.bicrement.com/">Zhuochun bicrement</a></li>
                            <li><a href="http://guanyilun.wordpress.com/author/guanyilun/">Yi Lun's Backyard</a></li>
                            <li><a href="http://flyfy1.github.io">Songyy's Thoughts</a></li>
                            <li><a href="http://qiang.hu">A Hu Qiang Blog</a></li>
                            <li><a href="http://joshuatj.com">JOSHUA.NG; I.AM.</a></li>
                            <li><a href="http://onethingihaveasked.wordpress.com/">One thing I have asked</a></li>
                        </ul>
                    </div>
                </div>
            </div>
		</div>				
		<footer class="page-footer teal lighten-2">
			<div class="container">
                <div class="row">
                    <div class="col l9 s12">
                        <h5 class="white-text">About</h5>
                        <p class="grey-text text-lighten-4">Simon is a software engineer who uses Java, Python and JavaScript.</p>
                    </div>
                    <div class="col l3 s12">
                        <h5 class="white-text">Connect</h5>
                            <iframe src="https://ghbtns.com/github-btn.html?user=swwl1992&type=follow&count=true" frameborder="0" scrolling="0" width="170px" height="20px"></iframe>
                            <script type="IN/MemberProfile" data-id="https://www.linkedin.com/pub/simon-wan-wenli/25/952/b81" data-format="hover" data-text="Simon Wan Wenli"></script>
                    </div>
                </div>
			</div>
            <div class="footer-copyright">
			    <div class="container"> <p>Copyright &copy; <b>Simon Wan Wenli</b>
                    &nbsp;2016
                    &nbsp;| Design from <a class="grey-text text-lighten-3" href="http://materializecss.com/"><b>Materialize</b></a></p>
                </div>
            </div>
		</footer>
		<script type="text/javascript" src="/js/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="/js/materialize.min.js"></script>
	</body>
</html>
