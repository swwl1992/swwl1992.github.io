<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width">
		<title>Offset topic and consumer group coordinator of Kafka</title>
		<link href="/css/main.css" type="text/css" rel="stylesheet">
		<link href="/css/syntax.css" type="text/css" rel="stylesheet">
		<link href="/css/materialize.min.css" type="text/css" rel="stylesheet">
		<link href="/img/favicon.ico" rel="icon">
        <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
	</head>
	<body>		
		<nav class="teal lighten-2">
			<div class="nav-wrapper">
				<div class="container">
                    <a href="/" class="brand-logo hide-on-med-and-down">Salmon Blog</a>
					<ul id="nav" class="right">
						<li><a href="/">Home</a></li>
						<li><a href="http://apps.wanwenli.com">Salmon Apps</a></li>
						<li><a href="/categories.html">Categories</a></li>
					</ul>
				</div>
			</div>
		</nav>
		<div class="container">
            <div class="section">
                <div class="row">
                    <div class="col l9 s12">
                        <div class="content"><h3>Offset topic and consumer group coordinator of Kafka</h3>
<b>04 Nov 2016</b>
<div id="article">
<p>This article is to discuss two subjects
that are not frequently or clearly covered by official document or
online souces.</p>

<h4 id="offset-topic-the-consumeroffsets-topic">Offset topic (the <code class="highlighter-rouge">__consumer_offsets</code> topic)</h4>

<p>It is the only mysterious topic in Kafka log
and it cannot be deleted by using
<a href="https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/admin/TopicCommand.scala">TopicCommand</a>.
Unfortunately there is no dedicated official documentation
to explain this internal topic.
The closest source I can find is
<a href="http://www.slideshare.net/jjkoshy/offset-management-in-kafka">this set of slides</a>.
I strongly recommend reading it if you wish to understand
how this internal topic works.</p>

<p>In short,
<code class="highlighter-rouge">__consumer_offsets</code> is used to store <em>offsets</em> of consumers
which was previously stored only in ZooKeeper before version 0.8.1.1.
At the latest version of 0.8.X serious, i.e. 0.8.2.2,
the storage location of offsets can be configured by
<code class="highlighter-rouge">offsets.storage</code> whose value can be either <code class="highlighter-rouge">kafka</code> or <code class="highlighter-rouge">zookeeper</code>.
If it is <code class="highlighter-rouge">kafka</code>,
consumers are still able to commit offsets to ZooKeeper
by enabling <code class="highlighter-rouge">dual.commit.enabled</code>.
However since version 0.9,
consumer offsets have been designed to be stored on brokers only.</p>

<p>The partition key of the messages in <code class="highlighter-rouge">__consumer_offsets</code>
was handled in
<a href="https://github.com/apache/kafka/blob/0.8.2/core/src/main/scala/kafka/server/OffsetManager.scala">OffsetManager</a>
at version 0.8.X
and has been named as <code class="highlighter-rouge">OffsetKey</code> in
<a href="https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/GroupMetadataManager.scala">GroupMetadataManager</a>
since version 0.9.0.
It contains three pieces of information: groupId, topic and partition number,
and the key is serialized/de-serialized according to a schema called
<code class="highlighter-rouge">OFFSET_COMMIT_KEY_SCHEMA</code>.
The usage of schema is primarily for backward compatibility.
Unlike the behavior of
<a href="https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/producer/internals/DefaultPartitioner.java">DefaultPartitioner</a>,
the partition number inside <code class="highlighter-rouge">__consumer_offsets</code> is <em>not</em>
determined by the hash value of partition key
but only determined by the hash value of consumer group,
which is as simple as</p>
<div class="highlighter-rouge"><pre class="highlight"><code>Utils.abs(groupId.hashCode) % numPartitions
</code></pre>
</div>
<p>Here the <code class="highlighter-rouge">numPartitions</code> is configured by the value of
<code class="highlighter-rouge">offsets.topic.num.partitions</code> in broker configs
and is 50 by default.
This algorithm will be re-introduced later
in the part of consumer group coordination.</p>

<p>The values of offset messages which is named
<a href="https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/common/OffsetMetadataAndError.scala">OffsetMetadata</a>
have two versions.
At version 0.8.X, the value contains offset, metadata (often empty)
and a timestamp
while the timestamp had been split into commit and expire timestamps
since version 0.9.0.
Console consumers are able to consume messages from internal topics
and print them out nicely.
A sample command has been shown below:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>./kafka-simple-consumer-shell.sh --topic __consumer_offsets \
--partition 49 \
--broker-list localhost:9092 \
--formatter "kafka.server.OffsetManager\$OffsetsMessageFormatter"
</code></pre>
</div>
<p>By the way, <code class="highlighter-rouge">absolute("testGroup".hashCode() % 50) = 49</code>
which is the reason why partition 49 was specified.
It prints out:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[testGroup,testTopic-development,0]::OffsetAndMetadata[11,NO_METADATA,1478243992053]
[testGroup,testTopic-development,0]::OffsetAndMetadata[12,NO_METADATA,1478243992086]
[testGroup,testTopic-development,0]::OffsetAndMetadata[13,NO_METADATA,1478243992096]
[testGroup,testTopic-development,0]::OffsetAndMetadata[14,NO_METADATA,1478243992110]
</code></pre>
</div>

<p>However this is not the end of story,
because <code class="highlighter-rouge">__consumer_offsets</code> is also used by group coordinator
to store group metadata!
The following section discusses another new feature
introduced since version 0.9.0.</p>

<h4 id="group-coordinator-coordinated-rebalance">Group coordinator (coordinated rebalance)</h4>

<p>This section is my humble and shallow understanding about
broker coordinator of consumer groups.
Correct me if I ever miss something or make any mistake.</p>

<p>The introduction of coordinator, according to the
<a href="https://cwiki.apache.org/confluence/display/KAFKA/Kafka+Detailed+Consumer+Coordinator+Design">official wiki of Kafka</a>,
is to solve the <em>split brain</em> problem
which is a well known problem in a distributed system.</p>

</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'wanwenli'; // required: replace example with your forum shortname

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                    </div>
                    <div class="col l3 s12">
                        <h4 class="grey-text text-darken-4">Links</h4>
                        <ul>
                            <li><a href="http://chenyuio.com">Chen Yu I/O</a></li>
                            <li><a href="http://www.bicrement.com/">Zhuochun bicrement</a></li>
                            <li><a href="http://guanyilun.wordpress.com/author/guanyilun/">Yi Lun's Backyard</a></li>
                            <li><a href="http://flyfy1.github.io">Songyy's Thoughts</a></li>
                            <li><a href="http://qiang.hu">A Hu Qiang Blog</a></li>
                            <li><a href="http://joshuatj.com">JOSHUA.NG; I.AM.</a></li>
                            <li><a href="http://onethingihaveasked.wordpress.com/">One thing I have asked</a></li>
                        </ul>
                    </div>
                </div>
            </div>
		</div>				
		<footer class="page-footer teal lighten-2">
			<div class="container">
                <div class="row">
                    <div class="col l9 s12">
                        <h5 class="white-text">About</h5>
                        <p class="grey-text text-lighten-4">Simon is a software engineer who uses Java, Python and JavaScript.</p>
                    </div>
                    <div class="col l3 s12">
                        <h5 class="white-text">Connect</h5>
                            <iframe src="https://ghbtns.com/github-btn.html?user=swwl1992&type=follow&count=true" frameborder="0" scrolling="0" width="170px" height="20px"></iframe>
                            <script type="IN/MemberProfile" data-id="https://www.linkedin.com/pub/simon-wan-wenli/25/952/b81" data-format="hover" data-text="Simon Wan Wenli"></script>
                    </div>
                </div>
			</div>
            <div class="footer-copyright">
			    <div class="container"> <p>Copyright &copy; <b>Simon Wan Wenli</b>
                    &nbsp;2016
                    &nbsp;| Design from <a class="grey-text text-lighten-3" href="http://materializecss.com/"><b>Materialize</b></a></p>
                </div>
            </div>
		</footer>
		<script type="text/javascript" src="/js/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="/js/materialize.min.js"></script>
	</body>
</html>
